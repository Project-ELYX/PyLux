#!/usr/bin/env bash

##! name: vcache
##! desc: Manage PyLux shared package cache
##! group: cache-management
##! <.ELYX.>

# ANSI Colors
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
CYAN='\033[36m'
WHITE='\033[37m'
BRIGHT_RED='\033[91m'
BRIGHT_GREEN='\033[92m'
BRIGHT_YELLOW='\033[93m'
BRIGHT_CYAN='\033[96m'
BRIGHT_MAGENTA='\033[95m'
RESET='\033[0m'

CACHE_DIR="$HOME/pylux-cache"
PACKAGES_DIR="$CACHE_DIR/packages"
REGISTRY_FILE="$CACHE_DIR/registry.json"

# Initialize cache if needed
init_cache() {
    if [ ! -d "$CACHE_DIR" ]; then
        mkdir -p "$PACKAGES_DIR"
        echo '{}' > "$REGISTRY_FILE"
    fi
}

# Show cache status
show_status() {
    echo -e "${BRIGHT_MAGENTA}[*] +++ PYLUX PACKAGE CACHE STATUS +++${RESET}"
    echo ""
    
    if [ ! -d "$CACHE_DIR" ]; then
        echo -e "${YELLOW}Cache not initialized${RESET}"
        echo -e "${WHITE}Run 'vcache init' to create cache${RESET}"
        return
    fi
    
    # Calculate cache size
    CACHE_SIZE=$(du -sh "$CACHE_DIR" 2>/dev/null | awk '{print $1}')
    
    # Count packages
    PACKAGE_COUNT=0
    if [ -d "$PACKAGES_DIR" ]; then
        PACKAGE_COUNT=$(find "$PACKAGES_DIR" -mindepth 2 -maxdepth 2 -type d | wc -l)
    fi
    
    echo -e "${BRIGHT_CYAN}Cache Location:${RESET} $CACHE_DIR"
    echo -e "${BRIGHT_CYAN}Total Size:${RESET} $CACHE_SIZE"
    echo -e "${BRIGHT_CYAN}Cached Versions:${RESET} $PACKAGE_COUNT package versions"
    echo ""
    
    # Show top 10 largest packages
    echo -e "${BRIGHT_CYAN}Largest Cached Packages:${RESET}"
    if [ -d "$PACKAGES_DIR" ]; then
        du -sh "$PACKAGES_DIR"/*/* 2>/dev/null | sort -rh | head -10 | while read size path; do
            pkg=$(basename "$(dirname "$path")")
            ver=$(basename "$path")
            echo -e "  ${WHITE}$size${RESET} - ${GREEN}$pkg${RESET} ${CYAN}$ver${RESET}"
        done
    fi
    echo ""
    
    # Show venv usage from registry
    if [ -f "$REGISTRY_FILE" ]; then
        TOTAL_VENVS=$(jq -r 'to_entries | map(.value) | flatten | unique | length' "$REGISTRY_FILE" 2>/dev/null || echo "0")
        echo -e "${BRIGHT_CYAN}Venvs Using Cache:${RESET} $TOTAL_VENVS"
    fi
}

# Clean orphaned packages
clean_cache() {
    echo -e "${BRIGHT_MAGENTA}[*] +++ CLEANING PACKAGE CACHE +++${RESET}"
    echo ""
    
    if [ ! -f "$REGISTRY_FILE" ]; then
        echo -e "${YELLOW}No registry found, nothing to clean${RESET}"
        return
    fi
    
    echo -e "${CYAN}Scanning for orphaned packages...${RESET}"
    
    REMOVED_COUNT=0
    FREED_SPACE=0
    
    # Find all cached packages
    if [ -d "$PACKAGES_DIR" ]; then
        while IFS= read -r pkg_dir; do
            PKG_NAME=$(basename "$(dirname "$pkg_dir")")
            PKG_VERSION=$(basename "$pkg_dir")
            CACHE_KEY="${PKG_NAME}-${PKG_VERSION}"
            
            # Check if any venv uses this
            VENV_COUNT=$(jq -r ".[\"$CACHE_KEY\"] // [] | length" "$REGISTRY_FILE" 2>/dev/null || echo "0")
            
            if [ "$VENV_COUNT" -eq 0 ]; then
                # Orphaned! Calculate size before removing
                SIZE=$(du -sb "$pkg_dir" 2>/dev/null | awk '{print $1}')
                FREED_SPACE=$((FREED_SPACE + SIZE))
                
                echo -e "${YELLOW}  Removing: ${GREEN}$PKG_NAME${RESET} ${CYAN}$PKG_VERSION${RESET} (orphaned)"
                rm -rf "$pkg_dir"
                ((REMOVED_COUNT++))
            fi
        done < <(find "$PACKAGES_DIR" -mindepth 2 -maxdepth 2 -type d)
    fi
    
    # Convert bytes to human readable
    if [ $FREED_SPACE -gt 0 ]; then
        FREED_HUMAN=$(numfmt --to=iec-i --suffix=B $FREED_SPACE 2>/dev/null || echo "$FREED_SPACE bytes")
    else
        FREED_HUMAN="0B"
    fi
    
    echo ""
    echo -e "${BRIGHT_GREEN}✓ Removed $REMOVED_COUNT orphaned package versions${RESET}"
    echo -e "${BRIGHT_GREEN}✓ Freed $FREED_HUMAN${RESET}"
}

# Rebuild registry by scanning venvs
rebuild_registry() {
    echo -e "${BRIGHT_MAGENTA}[*] +++ REBUILDING CACHE REGISTRY +++${RESET}"
    echo ""
    
    init_cache
    
    echo -e "${CYAN}Scanning venvs in ~/pylux-venvs/...${RESET}"
    
    # Start fresh registry
    echo '{}' > "$REGISTRY_FILE"
    
    VENV_DIR="$HOME/pylux-venvs"
    
    if [ ! -d "$VENV_DIR" ]; then
        echo -e "${YELLOW}No venvs directory found${RESET}"
        return
    fi
    
    SCANNED=0
    
    for venv_path in "$VENV_DIR"/*/; do
        if [ ! -d "$venv_path" ]; then
            continue
        fi
        
        VENV_NAME=$(basename "$venv_path")
        ((SCANNED++))
        
        echo -e "${WHITE}  Scanning: $VENV_NAME${RESET}"
        
        # Get pip list from this venv
        if [ -f "$venv_path/bin/pip" ]; then
            "$venv_path/bin/pip" list --format=json 2>/dev/null | jq -r '.[] | "\(.name)-\(.version)"' 2>/dev/null | while read cache_key; do
                if [ -n "$cache_key" ]; then
                    # Add to registry
                    TMP_FILE=$(mktemp)
                    jq --arg key "$cache_key" --arg venv "$VENV_NAME" \
                        '.[$key] = (.[$key] // []) + [$venv] | .[$key] |= unique' \
                        "$REGISTRY_FILE" > "$TMP_FILE" && mv "$TMP_FILE" "$REGISTRY_FILE"
                fi
            done
        fi
    done
    
    echo ""
    echo -e "${BRIGHT_GREEN}✓ Rebuilt registry from $SCANNED venvs${RESET}"
}

# Show help
show_help() {
    echo -e "${BRIGHT_CYAN}PyLux Package Cache Manager${RESET}"
    echo ""
    echo -e "${WHITE}Usage:${RESET}"
    echo -e "  vcache status       - Show cache size and contents"
    echo -e "  vcache clean        - Remove orphaned packages"
    echo -e "  vcache rebuild      - Rebuild registry from existing venvs"
    echo -e "  vcache init         - Initialize cache directory"
    echo ""
    echo -e "${CYAN}The package cache saves disk space by storing packages once${RESET}"
    echo -e "${CYAN}and hardlinking them into multiple venvs.${RESET}"
}

# Main
case "${1:-status}" in
    status)
        init_cache
        show_status
        ;;
    clean)
        init_cache
        clean_cache
        ;;
    rebuild)
        rebuild_registry
        ;;
    init)
        init_cache
        echo -e "${BRIGHT_GREEN}✓ Cache initialized at $CACHE_DIR${RESET}"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${BRIGHT_RED}Unknown command: $1${RESET}"
        echo ""
        show_help
        exit 1
        ;;
esac
